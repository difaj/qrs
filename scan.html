<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>QR Scanner</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        body {
            margin: 0;
            padding: 0;
            font-family: Arial, sans-serif;
            background-color: var(--tg-theme-bg-color, #121212);
            color: var(--tg-theme-text-color, #ffffff);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .container {
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
        }
        button {
            padding: 16px 24px;
            font-size: 18px;
            border-radius: 12px;
            border: 2px solid var(--tg-theme-button-color, #bb86fc);
            background-color: var(--tg-theme-secondary-bg-color, rgba(0,0,0,0.2));
            color: var(--tg-theme-button-color, #bb86fc);
            cursor: pointer;
            transition: all 0.3s;
        }
        button:hover {
            background-color: var(--tg-theme-button-color, #bb86fc);
            color: var(--tg-theme-button-text-color, #ffffff);
        }
    </style>
</head>
<body>
    <div class="container">
        <button onclick="PayStarsApp.showScanQrPopup(true);" data-haptic="warning" oncontextmenu="return false;">
            Відкрити сканер
        </button>
    </div>
    <script>
        const PayStarsApp = {
            initDone: false,
            webApp: null,

            init: function() {
                if (this.initDone) return true;
                if (window.Telegram && window.Telegram.WebApp) {
                    this.webApp = Telegram.WebApp;
                    this.webApp.ready();
                    this.webApp.expand();
                    this.initDone = true;
                    console.log('Telegram WebApp initialized');
                    return true;
                }
                console.error('Telegram WebApp not available');
                return false;
            },

            showScanQrPopup: function(linksOnly) {
                console.log('Attempting to open QR scanner with linksOnly:', linksOnly);
                if (!this.init()) {
                    console.error('Initialization failed');
                    return;
                }
                if (!this.webApp.isVersionAtLeast('6.7')) {
                    console.error('QR scanning requires Telegram WebApp version 6.7 or higher');
                    return;
                }
                this.webApp.HapticFeedback.notificationOccurred('warning');
                try {
                    this.webApp.showScanQrPopup(
                        { text: 'Скануйте QR-код' },
                        (result) => {
                            console.log('QR code scanned:', result);
                            this.webApp.closeScanQrPopup();
                            if (result.startsWith('http://') || result.startsWith('https://')) {
                                console.log('Opening web link:', result);
                                this.webApp.openLink(result);
                            } else if (result.startsWith('tg://resolve/?domain=')) {
                                console.log('Opening Telegram resolve link:', result);
                                this.webApp.openTelegramLink(result);
                            } else if (result.startsWith('tg://')) {
                                console.log('Opening Telegram link:', result);
                                this.webApp.openLink(result);
                            } else {
                                console.log('Scanned content (not a link):', result);
                                // Show the scanned content
                                this.webApp.showAlert(result);
                            }
                        }
                    );
                } catch (error) {
                    console.error('Error scanning QR code:', error);
                    this.webApp.closeScanQrPopup();
                    // Повторно відкриваємо сканер у разі помилки
                    setTimeout(() => this.showScanQrPopup(true), 500);
                }
            },

            setupHapticFeedback: function() {
                document.querySelectorAll('[data-haptic]').forEach(el => {
                    el.addEventListener('click', () => {
                        if (this.webApp) {
                            this.webApp.HapticFeedback.notificationOccurred(el.dataset.haptic);
                        }
                    });
                });
            }
        };

        document.addEventListener('DOMContentLoaded', () => {
            PayStarsApp.init();
            PayStarsApp.setupHapticFeedback();
        });
    </script>
</body>
</html>
